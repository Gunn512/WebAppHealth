@model List<WebAppHealth.Models.AppointmentDetailVM>
@{
    ViewBag.Title = "Kết Quả Tra Cứu";
    Layout = "~/Views/Shared/_ServiceLayout.cshtml";
}

@section Styles {
    <style>

        .result-container {
            max-width: 100rem;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .page-title {
            color: #00bfa5;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 3rem;
        }

        .btn {
            font-size: 1.5rem;
        }

        /* --- 2. DANH SÁCH (ACCORDION HEADER) --- */
        .accordion-item {
            border: none;
            border-radius: 8px !important;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .accordion-button {
            padding: 20px 25px;
            background: #fff;
            color: #333;
            font-size: 1.5rem;
        }

            .accordion-button:not(.collapsed) {
                background-color: #e0f2f1; /* Màu nền khi mở */
                color: #00695c;
                box-shadow: none;
            }

            .accordion-button:focus {
                box-shadow: none;
            }

        /* Grid layout cho nội dung trong nút header */
        .header-grid {
            width: 100%;
            display: grid;
            grid-template-columns: 20% 35% 20% 20%;
            align-items: center;
            gap: 10px;
        }

        @@media (max-width: 768px) {
            .header-grid {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .header-col {
                margin-bottom: 5px;
            }

            .page-title {
                font-size: 1.5rem;
            }
        }

        .header-label {
            font-size: 0.85rem;
            color: #777;
            display: none;
        }

        @@media (max-width: 768px) {
            .header-label {
                display: inline-block;
                margin-right: 5px;
            }
        }

        /* --- 3. CHI TIẾT PHIẾU KHÁM (CARD) --- */
        .ticket-wrapper {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .ticket-top-border {
            height: 1rem;
            background-color: var(--main);
            /*            background: linear-gradient(90deg, #00bfa5, #2196f3);*/
            width: 100%;
        }

        .ticket-header h4 {
            color: #00bfa5;
            font-weight: 700;
            margin-top: 2rem;
            font-size: 2rem;
        }

        .ticket-body {
            padding: 30px;
            font-size: 1.5rem;
        }

        .info-row {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
        }

        .info-label {
            font-weight: 600;
            width: 140px;
            flex-shrink: 0;
        }

        .info-value {
            font-weight: 500;
            flex-grow: 1;
        }

        /* --- 4. BARCODE --- */
        .barcode-box {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            background: #fafafa;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .barcode {
            width: 100%;
            min-height: 8rem;
            max-width: 25rem;
        }

        /* Badge status */
        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: 600;
            display: inline-block;
            text-align: center;
        }
    </style>
}

<div class="container py-4 result-container">
    <div class="page-header">
        <h2 class="page-title">DANH SÁCH LỊCH HẸN</h2>
        <a href="@Url.Action("Index", "AppointmentManage")" class="btn btn-outline-secondary btn-sm mt-2 m-md-4 rounded-pill px-4">
            <i class="fas fa-search me-2"></i>Tra cứu lại
        </a>
    </div>

    @if (Model != null && Model.Count > 0)
    {
        <div class="accordion" id="appointmentAccordion">
            @foreach (var item in Model)
            {
                // Xử lý màu sắc
                string badgeClass = "bg-secondary text-white";
                string statusText = item.Status;
                string rowBorder = "";

                if (item.Status == "Pending")
                {
                    badgeClass = "bg-warning text-dark";
                    statusText = "Chờ duyệt";
                }
                else if (item.Status == "Confirmed")
                {
                    badgeClass = "bg-success text-white";
                    statusText = "Đã xác nhận";
                    rowBorder = "border-success";
                }
                else if (item.Status == "Cancelled")
                {
                    badgeClass = "bg-danger text-white";
                    statusText = "Đã hủy";
                }
                else if (item.Status == "Completed")
                {
                    badgeClass = "bg-primary text-white";
                    statusText = "Đã khám";
                }

                <div class="accordion-item @rowBorder">
                    <h2 class="accordion-header" id="heading-@item.AppointmentID">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@item.AppointmentID" aria-expanded="false">

                            <div class="header-grid">
                                <div class="header-col">
                                    <span class="header-label">Ngày:</span>
                                    <i class="far fa-calendar-alt me-2 d-none d-md-inline"></i>@item.NgayKham
                                </div>
                                <div class="header-col fw-bold text-dark">
                                    <span class="header-label">Khoa:</span>
                                    @item.ChuyenKhoa
                                </div>
                                <div class="header-col text-muted">
                                    <span class="header-label">Loại:</span>
                                    @item.DoiTuong
                                </div>
                                <div class="header-col">
                                    <span class="status-badge @badgeClass">@statusText</span>
                                </div>
                            </div>

                        </button>
                    </h2>
                    <div id="collapse-@item.AppointmentID" class="accordion-collapse collapse" aria-labelledby="heading-@item.AppointmentID" data-bs-parent="#appointmentAccordion">
                        <div class="accordion-body bg-light p-4">

                            <div class="ticket-wrapper shadow-sm mx-auto">
                                <div class="ticket-top-border"></div>

                                <div class="row g-0">
                                    <div class="col-lg-7 border-end">
                                        <div class="ticket-header text-center">
                                            <h4>PHIẾU HẸN KHÁM</h4>
                                            <p class="text-muted small">BỆNH VIỆN ĐA KHOA TAM BÌNH</p>
                                        </div>
                                        <div class="ticket-body">
                                            <div class="info-row">
                                                <span class="info-label">Mã hồ sơ:</span>
                                                <span class="info-value fw-bold">@item.MaKCB</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Họ tên:</span>
                                                <span class="info-value text-uppercase fw-bold">@item.HoTen</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Ngày sinh:</span>
                                                <span class="info-value">@item.NgaySinh</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Ngày khám:</span>
                                                <span class="info-value fw-bold">@item.NgayKham</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Giờ khám:</span>
                                                <span class="info-value fw-bold">@item.GioKham</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Bác sĩ:</span>
                                                <span class="info-value">@item.BacSi</span>
                                            </div>
                                            <div class="info-row border-0">
                                                <span class="info-label">Triệu chứng:</span>
                                                <span class="info-value fst-italic text-muted">@item.TrieuChung</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-5 bg-white">
                                        <div class="p-4 h-100 d-flex flex-column justify-content-between">

                                            <div class="barcode-box mb-3">
                                                <svg class="barcode"
                                                     data-format="CODE128"
                                                     data-value="@item.BarcodeData"
                                                     data-text="@item.BarcodeData"
                                                     data-font-options="bold">
                                                </svg>
                                                <small class="text-muted mt-2 d-block">Đưa mã này tại quầy tiếp đón</small>
                                            </div>

                                            <div class="d-grid gap-2">
                                                @if (item.Status == "Pending" || item.Status == "Confirmed")
                                                {
                                                    @*<a href="@Url.Action("RegisterStandardExam", "ServicePortal", new { rescheduleId = item.AppointmentID })" class="btn btn-warning fw-bold text-dark">
                                                            <i class="fas fa-exchange-alt me-2"></i>Đổi lịch khám
                                                        </a>*@
                                                    <a href="@Url.Action("RedirectToReschedule", "AppointmentManage", new { id = item.AppointmentID })"
                                                       class="btn btn-warning text-dark btn-action">
                                                        <i class="fas fa-calendar-check me-2"></i>Đổi lịch
                                                    </a>
                                                    <button class="btn btn-outline-danger fw-bold btn-cancel" data-id="@item.AppointmentID">
                                                        <i class="fas fa-times me-2"></i>Hủy lịch hẹn
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="btn btn-secondary" disabled>Không thể thao tác</button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-5">
            <i class="fas fa-search-minus fa-3x mb-3 text-muted"></i>
            <h4>Không tìm thấy lịch hẹn nào!</h4>
            <p>Vui lòng kiểm tra lại thông tin tra cứu.</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function(){

            // --- HÀM RENDER BARCODE ---
            function renderBarcodes() {
                $(".barcode").each(function(){
                    var val = $(this).data("value");
                    if(val && typeof JsBarcode !== 'undefined'){
                        try {
                            JsBarcode(this, val, {
                                format: "CODE128",
                                lineColor: "#000",
                                width: 2,
                                height: 140,
                                displayValue: true,
                                fontSize: 16
                            });
                        } catch(e) {
                            console.error("Lỗi tạo barcode:", e);
                        }
                    }
                });
            }

            // Gọi lần đầu khi trang load
            renderBarcodes();

            // Gọi lại khi bấm mở accordion (Fix lỗi barcode bị ẩn/nhỏ khi nằm trong tab ẩn)
            $('.accordion-button').click(function() {
                setTimeout(renderBarcodes, 200); // Đợi hiệu ứng mở xong thì vẽ lại
            });

            // --- LOGIC HỦY LỊCH ---
            $(".btn-cancel").click(function(e){
                e.preventDefault(); // Ngăn sự kiện mặc định
                if(!confirm("Bạn có chắc chắn muốn HỦY lịch hẹn này không? Hành động này không thể hoàn tác.")) return;

                var id = $(this).data("id");
                var btn = $(this);
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

                $.ajax({
                    url: '@Url.Action("CancelAppointment", "AppointmentManage")',
                    type: 'POST',
                    data: { id: id },
                    success: function(res) {
                        if (res.success) {
                            alert(res.message);
                            location.reload();
                        } else {
                            alert(res.message);
                            btn.prop('disabled', false).html('<i class="fas fa-times me-2"></i>Hủy lịch hẹn');
                        }
                    },
                    error: function() {
                        alert("Lỗi kết nối server.");
                        btn.prop('disabled', false).html('<i class="fas fa-times me-2"></i>Hủy lịch hẹn');
                    }
                });
            });
        });
    </script>
}
