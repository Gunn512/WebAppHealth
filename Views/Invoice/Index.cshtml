@model List<WebAppHealth.Models.ViewModels.InvoiceHistoryItem>
@{
    ViewBag.Title = "Tra Cứu Hóa Đơn";
    Layout = "~/Views/Shared/_ServiceLayout.cshtml";
}

@section Styles {
    <link href="~/Content/css/lookup_exam_results.css" rel="stylesheet" />
    <link href="~/Content/css/lookup_invoice.css" rel="stylesheet" />
}

<div class="container-main">
    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div id="invoice-list-view" class="invoice-list-view">
        <header class="form-header">
            <h1>LỊCH SỬ THANH TOÁN</h1>
            <p>Tra cứu và tải xuống hóa đơn điện tử cho các dịch vụ đã sử dụng.</p>
        </header>

        <div class="appointment-list-container">
            <div class="appointment-list-header">
                <div class="col-item col-date">Ngày lập</div>
                <div class="col-item col-spec">Số hóa đơn</div>
                <div class="col-item col-doc">Nội dung chính</div>
                <div class="col-item col-type">Tổng tiền</div>
            </div>

            @if (Model != null && Model.Count > 0)
            {
                foreach (var item in Model)
                {
                    <div class="appointment-list-row" data-invoice-id="@item.InvoiceID">
                        <div class="col-item col-date" data-label="Ngày lập">@item.CreatedDate</div>
                        <div class="col-item col-spec" data-label="Số hóa đơn">@item.InvoiceCode</div>
                        <div class="col-item col-doc" data-label="Nội dung">@item.Content</div>
                        <div class="col-item col-type fw-bold text-primary" data-label="Tổng tiền">
                            @item.TotalAmountStr
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="p-4 text-center text-muted">
                    <p>Bạn chưa có lịch sử thanh toán nào.</p>
                </div>
            }
        </div>
    </div>

    <div id="invoice-detail-view" style="display: none">
        <div class="mb-3 no-print">
            <button type="button" id="back-to-list-btn" class="back-link btn btn-link text-decoration-none ps-0">
                <i class="fa-solid fa-arrow-left me-2"></i> Quay lại danh sách
            </button>
        </div>

        <div class="mt-4 mb-5 text-end no-print">
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="fa-solid fa-print me-2"></i> In hóa đơn
            </button>
            <button class="btn btn-primary" id="download-pdf-btn">
                <i class="fa-solid fa-file-pdf me-2"></i> Tải PDF
            </button>
        </div>

        <div class="invoice-paper">
            <img src="/asset/logo_01.png" class="watermark" alt="Watermark" />

            <div class="row mb-4 position-relative" style="z-index: 1">
                <div class="col-7 inv-header-left">
                    <div class="d-flex align-items-start">
                        <img src="/asset/logo_03.png" alt="Logo" style="width: 60px; margin-right: 15px" />
                        <div>
                            <h4>BỆNH VIỆN ĐA KHOA KHU VỰC TAM BÌNH</h4>
                            <p><strong>Mã số thuế:</strong> 0303390013</p>
                            <p>Địa chỉ: Tam Bình, Vĩnh Long</p>
                            <p>Điện thoại: (028) 3722 3556</p>
                        </div>
                    </div>
                </div>

                <div class="col-5 inv-header-right">
                    <div class="mt-2">
                        <p class="mb-0">Mẫu số: <strong>02GTTT0/001</strong></p>
                        <p class="mb-0">Ký hiệu: <strong>AA/19E</strong></p>
                        <div class="inv-number-group">
                            <span class="inv-number-label">Số: </span>
                            <span class="inv-number-value" id="inv-number-display"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4 text-center title-name">
                <h2 class="inv-title">HÓA ĐƠN BÁN HÀNG</h2>
                <div class="inv-sub-title">(HÓA ĐƠN VIỆN PHÍ)</div>
                <div class="inv-date" id="inv-date-text"></div>
            </div>

            <div class="customer-info position-relative" style="z-index: 1">
                <div class="d-flex">
                    <label>Họ tên người mua hàng:</label>
                    <span class="fw-bold text-uppercase" id="inv-patient-name"></span>
                </div>
                <div class="d-flex">
                    <label>Số điện thoại:</label>
                    <span id="inv-phone"></span>
                </div>
                <div class="d-flex">
                    <label>Địa chỉ:</label>
                    <span id="inv-address"></span>
                </div>
                <div class="d-flex">
                    <label>Hình thức thanh toán:</label>
                    <span id="inv-payment-method"></span>
                </div>
            </div>

            <div class="position-relative" style="z-index: 1">
                <table class="table-invoice-custom">
                    <thead>
                        <tr style="text-transform: uppercase">
                            <th style="width: 5rem">STT</th>
                            <th>Tên hàng hóa, dịch vụ</th>
                            <th style="width: 8rem">ĐVT</th>
                            <th style="width: 8rem">SL</th>
                            <th style="width: 10rem">Đơn giá</th>
                            <th style="width: 12rem">Thành tiền</th>
                        </tr>
                    </thead>
                    <thead>
                        <tr style="font-size:1.4rem; color: red; font-style: italic;">
                            <th>(1)</th>
                            <th>(2)</th>
                            <th>(3)</th>
                            <th>(4)</th>
                            <th>(5)</th>
                            <th>(6 = 4x5)</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items-body"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="fw-bold ps-3">Tạm tính:</td>
                            <td class="text-end" id="inv-subtotal">0</td>
                        </tr>
                        <tr>
                            <td colspan="5" class="fw-bold ps-3">Thuế GTGT (VAT):</td>
                            <td class="text-end" id="inv-vat">0</td>
                        </tr>
                        <tr>
                            <td colspan="5" class="fw-bold ps-3">Cộng tiền bán hàng hóa dịch vụ:</td>
                            <td class="text-end fw-bold pe-2" id="inv-grand-total">0</td>
                        </tr>
                    </tfoot>
                </table>

                <div class="money-in-words">
                    Số tiền viết bằng chữ: <span id="inv-money-word" class="fw-normal"></span>
                </div>
            </div>

            <div class="row signature-block position-relative" style="z-index: 1">
                <div class="col-6">
                    <div class="signature-title">Người mua hàng</div>
                    <div class="signature-note">(Ký, ghi rõ họ, tên)</div>
                </div>
                <div class="col-6">
                    <div class="signature-title">Người bán hàng</div>
                    <div class="signature-note">(Ký, đóng dấu, ghi rõ họ, tên)</div>
                    <div style="height: 1rem"></div>
                    <div class="digital-signature-box">
                        <div class="valid-text">Signature Valid</div>
                        <div>Ký bởi: BỆNH VIỆN ĐA KHOA</div>
                        <div>KHU VỰC TAM BÌNH</div>
                        <div id="sign-date"></div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5 fst-italic text-muted footer-invoice">
                <p>(Cần kiểm tra, đối chiếu khi lập, giao nhận hóa đơn)</p>
                <p>Tra cứu tại website bệnh viện.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Element Binding
            const listView = document.getElementById("invoice-list-view");
            const detailView = document.getElementById("invoice-detail-view");
            const backBtn = document.getElementById("back-to-list-btn");
            const loading = document.getElementById("loading");
            const clickableRows = document.querySelectorAll(".appointment-list-row");

            // Detail Elements
            const elInvNumber = document.getElementById("inv-number-display");
            const elInvDate = document.getElementById("inv-date-text");
            const elPatientName = document.getElementById("inv-patient-name");
            const elPhone = document.getElementById("inv-phone");
            const elAddress = document.getElementById("inv-address");
            const elPaymentMethod = document.getElementById("inv-payment-method");
            const elTableBody = document.getElementById("invoice-items-body");
            const elSubTotal = document.getElementById("inv-subtotal");
            const elVAT = document.getElementById("inv-vat");
            const elGrandTotal = document.getElementById("inv-grand-total");
            const elMoneyWord = document.getElementById("inv-money-word");
            const elSignDate = document.getElementById("sign-date");

            // Click Logic
            clickableRows.forEach((row) => {
                row.addEventListener("click", function () {
                    const invoiceId = this.dataset.invoiceId;
                    loading.style.display = "block";

                    fetch('/Invoice/GetDetail?invoiceId=' + invoiceId)
                        .then(response => response.json())
                        .then(res => {
                            loading.style.display = "none";
                            if (res.success) {
                                fillData(res.data);
                                listView.style.display = "none";
                                detailView.style.display = "block";
                                window.scrollTo(0, 0);
                            } else {
                                alert(res.message);
                            }
                        })
                        .catch(err => {
                            loading.style.display = "none";
                            console.error(err);
                            alert("Lỗi tải dữ liệu");
                        });
                });
            });

            function fillData(data) {
                elInvNumber.textContent = data.InvoiceCode;
                elInvDate.textContent = data.CreatedDateString;
                elPatientName.textContent = data.PatientName;
                elPhone.textContent = data.PhoneNumber;
                elAddress.textContent = data.Address;
                elPaymentMethod.textContent = data.PaymentMethod;
                elSignDate.textContent = "Ký " + data.CreatedDateString.toLowerCase();

                elTableBody.innerHTML = "";
                if (data.Items && data.Items.length > 0) {
                    data.Items.forEach(item => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                                            <td class="text-center">${item.Stt}</td>
                                            <td>${item.Name}</td>
                                            <td class="text-center">${item.Unit || ''}</td>
                                            <td class="text-center">${item.Quantity}</td>
                                            <td class="text-end">${formatCurrency(item.UnitPrice)}</td>
                                            <td class="text-end">${formatCurrency(item.TotalPrice)}</td>
                                        `;
                        elTableBody.appendChild(tr);
                    });
                } else {
                    elTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Không có dữ liệu</td></tr>';
                }

                elSubTotal.textContent = formatCurrency(data.SubTotal) + " đ";
                elVAT.textContent = formatCurrency(data.VAT) + " đ";
                elGrandTotal.textContent = formatCurrency(data.GrandTotal) + " đ";

                if (typeof DOCSO !== 'undefined') {
                    elMoneyWord.textContent = DOCSO.doc(data.GrandTotal);
                }
            }

            function formatCurrency(num) {
                return new Intl.NumberFormat("vi-VN").format(num);
            }

            backBtn.addEventListener("click", function () {
                detailView.style.display = "none";
                listView.style.display = "block";
                window.scrollTo(0, 0);
            });

            // DOCSO library code (Paste the DOCSO function you had here)
            const DOCSO = (function () {
                const t = ["không", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
                const r = function (r, n) {
                    let o = "", a = Math.floor(r / 10), e = r % 10;
                    return (
                        a > 1 ? ((o = " " + t[a] + " mươi"), 1 == e && (o += " mốt")) : 1 == a ? ((o = " mười"), 1 == e && (o += " một")) : n && e > 0 && (o = " lẻ"),
                        5 == e && a >= 1 ? (o += " lăm") : 4 == e && a >= 1 ? (o += " tư") : (e > 1 || (1 == e && 0 == a)) && (o += " " + t[e]), o
                    );
                };
                const n = function (n, o) {
                    let a = "", e = Math.floor(n / 100), m = n % 100;
                    return o || e > 0 ? ((a = " " + t[e] + " trăm"), (a += r(m, !0))) : (a = r(m, !1)), a;
                };
                const o = function (t, r) {
                    let o = "", a = Math.floor(t / 1e6), t_rest = t % 1e6;
                    a > 0 && ((o = n(a, r) + " triệu"), (r = !0));
                    let e = Math.floor(t_rest / 1e3), m = t_rest % 1e3;
                    return e > 0 && ((o += n(e, r) + " nghìn"), (r = !0)), m > 0 && (o += n(m, r)), o;
                };
                return {
                    doc: function (r) {
                        if (0 == r) return "Không đồng";
                        let l = "", a = "";
                        do {
                            let ty = r % 1e9; r = Math.floor(r / 1e9); l = r > 0 ? o(ty, !0) + a + l : o(ty, !1) + a + l; a = " tỷ";
                        } while (r > 0);
                        l = l.trim();
                        return l.charAt(0).toUpperCase() + l.slice(1) + " đồng chẵn./.";
                    },
                };
            })();
        });
    </script>
}