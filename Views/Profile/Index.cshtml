@model WebAppHealth.Models.ViewModels.UserProfileVM
@{
    ViewBag.Title = "Hồ Sơ Cá Nhân";
    Layout = "~/Views/Shared/_ServiceLayout.cshtml";
}

@section Styles {
    <link href="~/Content/css/profile.css" rel="stylesheet" />
}

<div class="container pb-5">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="profile-card text-center pb-3">
                <div class="profile-header"></div>
                <div class="avatar-container">
                    <img src="@Url.Content(string.IsNullOrEmpty(Model.AvatarUrl) ? "~/asset/avatar-10.jpg" : Model.AvatarUrl)"
                         alt="Avatar"
                         class="avatar-img"
                         id="userAvatar" />
                    <button class="btn-edit-avatar" title="Đổi ảnh đại diện">
                        <i class="fa-solid fa-camera text-muted"></i>
                    </button>
                </div>
                <div class="mt-3 px-3">
                    <h5 class="mb-1 fw-bold" id="displayName">@(Model.FullName ?? "Chưa cập nhật tên")</h5>
                    <p class="text-muted mb-2 displayID">
                        Mã bệnh nhân: <span class="fw-bold">@Model.PatientCode</span>
                    </p>
                    <span class="status-badge status-active">Đã xác thực</span>
                </div>

                <div class="qr-code-box mt-4">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=@Model.PatientCode"
                         alt="QR Code"
                         class="img-fluid mb-2" />
                    <p class="small text-muted mb-0">Quét mã để check-in tại quầy</p>
                </div>
            </div>

            <div class="d-block d-lg-none profile-card p-3">
                <a href="#support-section" class="btn btn-outline-primary w-100">Cần hỗ trợ?</a>
            </div>
        </div>

        <div class="col-lg-6 main-section">
            <form id="profileForm">
                @Html.AntiForgeryToken()
                <div class="profile-card p-4">
                    <h4 class="section-title">Thông tin cá nhân</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="FullName" value="@Model.FullName" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ngày sinh <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="DateOfBirth" value="@Model.DateOfBirth" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Giới tính</label>
                            <select class="form-select" name="Gender" disabled>
                                <option value="Nam" @(Model.Gender == "Nam" ? "selected" : "")>Nam</option>
                                <option value="Nữ" @(Model.Gender == "Nữ" ? "selected" : "")>Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" value="@Model.PhoneNumber" style="font-size: 1.2rem" readonly />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" value="@Model.Email" style="font-size: 1.2rem" readonly />
                        </div>
                    </div>
                </div>

                <div class="profile-card p-4">
                    <h4 class="section-title">Định danh & BHYT</h4>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">CCCD/CMND</label>
                            <input type="text" class="form-control" name="IdentityCard" value="@Model.IdentityCard" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mã số BHYT</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="InsuranceNumber" value="@Model.InsuranceNumber" readonly />
                                <span class="input-group-text text-success"><i class="fa-solid fa-check-circle"></i></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Nơi đăng ký KCB ban đầu</label>
                            <input type="text" class="form-control" value="Bệnh viện Đa Khoa Khu Vực Tam Bình" readonly />
                        </div>
                    </div>
                </div>

                <div class="profile-card p-4 address-card">
                    <h4 class="section-title">Địa chỉ liên hệ</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Tỉnh/Thành phố</label>
                            <select class="form-select" id="province" name="City">
                                <option value="">-- Chọn Tỉnh/Thành --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quận/Huyện</label>
                            <select class="form-select" id="district" name="District">
                                <option value="">-- Chọn Quận/Huyện --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phường/Xã</label>
                            <select class="form-select" id="ward" name="Ward">
                                <option value="">-- Chọn Phường/Xã --</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Địa chỉ chi tiết</label>
                            <input type="text" class="form-control" name="Address" value="@Model.Address" placeholder="Số nhà, tên đường..." />
                        </div>
                    </div>
                </div>

                <input type="hidden" id="currentProvince" value="@Model.City" />
                <input type="hidden" id="currentDistrict" value="@Model.District" />
                <input type="hidden" id="currentWard" value="@Model.Ward" />

                <div class="profile-card p-4 contact-card">
                    <h4 class="section-title">Thông tin bổ sung</h4>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Người liên hệ khẩn cấp (Người thân)</label>
                        <div id="relatives-container">
                            @if (Model.Relatives != null && Model.Relatives.Count > 0)
                            {
                                foreach (var rel in Model.Relatives)
                                {
                                    <div class="row g-2 mb-2 relative-row">
                                        <div class="col-4">
                                            <input type="text" class="form-control" name="relative_name[]" value="@rel.FullName" placeholder="Họ tên">
                                        </div>
                                        <div class="col-3">
                                            <select class="form-select" name="relative_relation[]">
                                                <option selected>@rel.Relation</option>
                                                <option>Vợ/Chồng</option>
                                                <option>Cha/Mẹ</option>
                                                <option>Con</option>
                                            </select>
                                        </div>
                                        <div class="col-5">
                                            <div class="input-wrapper d-flex">
                                                <input type="tel" class="form-control" name="relative_phone[]" value="@rel.Phone" placeholder="SĐT">
                                                <button type="button" class="btn btn-link text-danger btn-remove-relative"><i class="fa-solid fa-xmark"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <button type="button" id="btn-add-relative" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fa-solid fa-plus"></i> Thêm người thân
                        </button>
                    </div>
                    <hr />
                    @*<div class="mb-3">
                            <label class="form-label fw-bold">Đính kèm giấy tờ (Giấy chuyển tuyến, CCCD...)</label>
                            <input type="file" class="form-control" multiple />
                            <small class="text-muted">Định dạng: PDF, JPG, PNG (Max 5MB)</small>
                        </div>*@
                </div>

                <div class="d-grid gap-2 mb-4 save-card">
                    <button type="submit" class="btn btn-primary btn-lg fw-bold">
                        <i class="fa-regular fa-save me-2"></i>LƯU CẬP NHẬT HỒ SƠ
                    </button>
                </div>
            </form>
        </div>

        <div class="col-lg-3">
            <div class="profile-card calendar-card">
                <div class="p-3 border-bottom bg-light">
                    <h3 class="m-0 fw-bold text-primary">
                        <i class="fa-regular fa-calendar-check me-2"></i>Lịch khám sắp tới
                    </h3>
                </div>
                <div class="p-3">
                    @if (Model.UpcomingAppointment != null)
                    {
                        <div class="alert alert-info mb-0" role="alert">
                            <strong>@Model.UpcomingAppointment.TimeStr - @Model.UpcomingAppointment.DateStr</strong><br />
                            @Model.UpcomingAppointment.DepartmentName<br />
                            <small class="fw-bold">BS. @Model.UpcomingAppointment.DoctorName</small>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/MedicalRecord/Index" class="text-decoration-none small">Xem tất cả lịch hẹn &rarr;</a>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3 text-muted">
                            <i class="fa-regular fa-calendar-xmark fa-2x mb-2"></i>
                            <p class="mb-2">Bạn không có lịch hẹn sắp tới.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary">Đặt lịch ngay</a>
                        </div>
                    }
                </div>
            </div>

            <div class="profile-card">
                <div class="p-3 border-bottom bg-light">
                    <h3 class="m-0 fw-bold text-danger">
                        <i class="fa-solid fa-user-shield me-3"></i>Bảo mật tài khoản
                    </h3>
                </div>
                <div class="d-flex flex-column">
                    <a href="#" class="widget-item">
                        <div class="widget-icon text-dark"><i class="fa-solid fa-key"></i></div>
                        <div>
                            <div class="fw-bold text-dark">Đổi mật khẩu</div>
                            <small class="text-muted">Cập nhật định kỳ</small>
                        </div>
                    </a>
                    <a href="#" class="widget-item">
                        <div class="widget-icon text-dark"><i class="fa-solid fa-mobile-screen"></i></div>
                        <div>
                            <div class="fw-bold text-dark">Thiết bị đăng nhập</div>
                            <small class="text-muted">Quản lý phiên</small>
                        </div>
                    </a>
                </div>
            </div>

            <div class="profile-card support-card" id="support-section">
                <div class="p-3 border-bottom bg-light">
                    <h3 class="m-0 fw-bold text-success">
                        <i class="fa-solid fa-headset me-3"></i>Hỗ trợ bệnh nhân
                    </h3>
                </div>
                <div class="p-3">
                    <p class="mb-2"><i class="fa-solid fa-phone me-4 text-success"></i>Hotline: <strong>1900 1234</strong></p>
                    <p class="mb-3"><i class="fa-brands fa-facebook-messenger me-4 text-primary"></i>Chat với CSKH</p>
                    <button class="btn btn-outline-success w-100 btn-sm">Gửi yêu cầu hỗ trợ</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toast-message">
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ==========================================
            // 1. XỬ LÝ LOGIC ĐỊA CHÍNH (Tỉnh/Huyện/Xã)
            // ==========================================
            const host = "https://provinces.open-api.vn/api/";
            const elProvince = document.getElementById("province");
            const elDistrict = document.getElementById("district");
            const elWard = document.getElementById("ward");

            // Lấy giá trị hiện tại từ Hidden Input (Dữ liệu từ DB)
            const currentProvVal = document.getElementById("currentProvince").value;
            const currentDistVal = document.getElementById("currentDistrict").value;
            const currentWardVal = document.getElementById("currentWard").value;

            // Load Tỉnh
            axios.get(host + "?depth=1").then((response) => {
                renderData(elProvince, response.data);
                // Pre-select nếu có dữ liệu cũ
                if (currentProvVal) {
                    setSelectedByText(elProvince, currentProvVal);
                    const code = getCodeByText(elProvince, currentProvVal);
                    if (code) callApiDistrict(host + "p/" + code + "?depth=2");
                }
            });

            // Chọn Tỉnh -> Load Huyện
            elProvince.addEventListener("change", function () {
                elDistrict.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
                elWard.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
                const code = elProvince.options[elProvince.selectedIndex].getAttribute("data-code");
                if (code) callApiDistrict(host + "p/" + code + "?depth=2");
            });

            // Chọn Huyện -> Load Xã
            elDistrict.addEventListener("change", function () {
                elWard.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
                const code = elDistrict.options[elDistrict.selectedIndex].getAttribute("data-code");
                if (code) callApiWard(host + "d/" + code + "?depth=2");
            });

            function callApiDistrict(api) {
                axios.get(api).then((response) => {
                    renderData(elDistrict, response.data.districts);
                    if (currentDistVal && elDistrict.options.length > 1) {
                        setSelectedByText(elDistrict, currentDistVal);
                        const code = getCodeByText(elDistrict, currentDistVal);
                        if (code) callApiWard(host + "d/" + code + "?depth=2");
                    }
                });
            }

            function callApiWard(api) {
                axios.get(api).then((response) => {
                    renderData(elWard, response.data.wards);
                    if (currentWardVal) setSelectedByText(elWard, currentWardVal);
                });
            }

            function renderData(selectElement, arrayData) {
                arrayData.forEach(element => {
                    let option = document.createElement("option");
                    option.setAttribute("data-code", element.code);
                    option.value = element.name; // Lưu TÊN vào DB
                    option.text = element.name;
                    selectElement.appendChild(option);
                });
            }

            function setSelectedByText(selectEl, textToFind) {
                for (let i = 0; i < selectEl.options.length; i++) {
                    if (selectEl.options[i].text === textToFind) {
                        selectEl.selectedIndex = i;
                        break;
                    }
                }
            }

            function getCodeByText(selectEl, textToFind) {
                for (let i = 0; i < selectEl.options.length; i++) {
                    if (selectEl.options[i].text === textToFind) {
                        return selectEl.options[i].getAttribute("data-code");
                    }
                }
                return null;
            }

            // ==========================================
            // 2. XỬ LÝ DANH SÁCH NGƯỜI THÂN (Dynamic)
            // ==========================================
            const container = document.getElementById("relatives-container");
            const addBtn = document.getElementById("btn-add-relative");

            if (addBtn && container) {
                // Nếu chưa có dòng nào, thêm 1 dòng trống
                if (container.children.length === 0) addRelativeRow();

                addBtn.addEventListener("click", function () {
                    addRelativeRow();
                });

                // Gắn sự kiện xóa cho các nút có sẵn (Render từ Server)
                container.addEventListener("click", function (e) {
                    if (e.target.closest(".btn-remove-relative")) {
                        e.target.closest(".relative-row").remove();
                    }
                });
            }

            function addRelativeRow() {
                const newRow = document.createElement("div");
                newRow.classList.add("row", "g-2", "mb-2", "relative-row");
                newRow.innerHTML = `
                                <div class="col-4">
                                    <input type="text" class="form-control" name="relative_name[]" placeholder="Họ tên">
                                </div>
                                <div class="col-3">
                                    <select class="form-select" name="relative_relation[]">
                                        <option>Vợ/Chồng</option><option>Cha/Mẹ</option><option>Con</option><option>Anh/Chị/Em</option>
                                    </select>
                                </div>
                                <div class="col-5">
                                    <div class="input-wrapper d-flex">
                                        <input type="tel" class="form-control" name="relative_phone[]" placeholder="SĐT">
                                        <button type="button" class="btn btn-link text-danger btn-remove-relative">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                </div>`;
                container.appendChild(newRow);
            }

            // ==========================================
            // 3. XỬ LÝ SUBMIT FORM (ĐÃ SỬA ĐỔI TOAST)
            // ==========================================
            const profileForm = document.getElementById("profileForm");

            if (profileForm) {
                profileForm.addEventListener("submit", function (e) {
                    e.preventDefault();

                    const formData = new FormData(profileForm);

                    // Hiệu ứng Loading nút bấm
                    const submitBtn = profileForm.querySelector("button[type='submit']");
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';
                    submitBtn.disabled = true;

                    fetch('/Profile/Update', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // THAY ALERT BẰNG TOAST MÀU XANH
                                showToast(data.message || "Cập nhật hồ sơ thành công!", "success");

                                // Tùy chọn: Reload sau 2 giây để thấy ảnh/dữ liệu mới
                                // setTimeout(() => window.location.reload(), 2000); 
                            } else {
                                // THAY ALERT BẰNG TOAST MÀU ĐỎ
                                showToast("Lỗi: " + data.message, "error");
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast("Đã xảy ra lỗi kết nối đến máy chủ.", "error");
                        })
                        .finally(() => {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        });
                });
            }

            // ==========================================
            // HÀM HIỂN THỊ THÔNG BÁO (TOAST)
            // ==========================================
            function showToast(message, type) {
                const toastEl = document.getElementById('liveToast');
                const toastBody = document.getElementById('toast-message');

                // Set nội dung
                toastBody.textContent = message;

                // Xóa class màu cũ
                toastEl.classList.remove('bg-success', 'bg-danger', 'text-white');

                // Thêm class màu mới dựa trên type
                if (type === 'success') {
                    toastEl.classList.add('bg-success', 'text-white');
                } else {
                    toastEl.classList.add('bg-danger', 'text-white');
                }

                // Gọi Bootstrap Toast để hiển thị
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            // ==========================================
            // 4. XỬ LÝ LOGOUT
            // ==========================================
            const logoutButton = document.getElementById("dashboard-logout-button");
            if (logoutButton) {
                logoutButton.addEventListener("click", function (event) {
                    event.preventDefault();
                    // Gọi Action Logout của Server
                    window.location.href = "/Account/Logout";
                });
            }
        });
    </script>
}